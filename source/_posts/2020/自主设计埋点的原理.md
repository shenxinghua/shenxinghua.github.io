---
title: 自主设计埋点的原理
date: 2020-01-02 14:18:52
datestring: "20200102"
pageid: 1
categories:
- 前端
tags:
- html
- js
photos: images/poster/html5.jpg
---

不论是哪个公司，对于投入了相当人力财力而发布的网页或者网站，总想知道效果如何，是否能达到预期的效果。那么要了解具体的效果，真实数据的支持是不可或缺的。其中前端的埋点是重要数据的来源之一。

## 什么是埋点呢？ 

埋点是网站分析的一种常用数据采集方法，采集的对象主要有用户行为数据，页面性能。大部分采集到的原始数据，还需要进行后期的加工，才能用于分析具体的表现。前端的埋点方法，大体分为两类：
+ 自主开发的手动埋点脚本
+ 借用第三方的自动埋点脚本

## 自主开发埋点脚本

埋点中有一部分是关于页面性能的数据，比如白屏时长、页面的http请求时间、页面的渲染时间、首屏加载时长等。通过Performance 我们便能拿到DNS 解析时间、TCP 建立连接时间、首页白屏时间、DOM 渲染完成时间、页面 load 时间等，如下所示：

```js
//拿到Performance并且初始化一些参数
let timing = performance.timing,
start = timing.navigationStart,
dnsTime = 0,
tcpTime = 0,
firstPaintTime = 0,
domRenderTime = 0,
loadTime = 0;
//根据提供的api和属性，拿到对应的时间
dnsTime = timing.domainLookupEnd - timing.domainLookupStart;
tcpTime = timing.connectEnd - timing.connectStart;
firstPaintTime = timing.responseStart - start;
domRenderTime = timing.domContentLoadedEventEnd - start;
loadTime = timing.loadEventEnd - start;

console.log('DNS解析时间:', dnsTime,
'nTCP建立时间:', tcpTime,
'n首屏时间:', firstPaintTime,
'ndom渲染完成时间:', domRenderTime,
'n页面onload时间:', loadTime);

```
拿到这些数据后我们可以通过Ajax或者通过图片等的方式去提交埋点内容。

```js
// 页面加载时发送埋点请求
$(document).ready(function(){
    ...
    sendRequest(params);
});
// 按钮点击时发送埋点请求
$('button').click(function(){
    ...
    sendRequest(params);
});

// 通过伪装成 Image 对象，传递给后端，防止跨域
let img = new Image(1, 1);
let src = `http://aaaaa/api/test.jpg?args=${encodeURIComponent(args)}`;
img.src = src;

//css实现的埋点
.link:active::after{
    content: url("http://www.example.com?action=yourdata");
}
<a>点击我，会发埋点数据</a>

//data自定义属性，rangjs去拿到属性绑定事件，实现埋点
<button data-mydata="{key:'uber_comt_share_ck', act: 'click',msg:{}}">购买</button>

```

另外，埋点还需要包含重要的一些用户行为数据。比如需求方关心的PV/UV（PV指页面浏览量或点击量；UV指访问某个站点或点击某条新闻的不同IP地址的数量）、用户的停留时间、页面的入口、用户的一些交互行为。




